# Build stage - Support custom image
{% if base_image_builder %}
FROM {{ base_image_builder }} AS builder
{% elif base_image_default_builder %}
FROM {{ base_image_default_builder }} AS builder
{% else %}
FROM agentkit-cn-beijing.cr.volces.com/base/compile_basego:1.24 AS builder
{% endif %}

WORKDIR /src

# copy full build context
COPY . .

# build-time args to control where the build places the binary
ARG BUILD_OUTPUT_DIR=/app
ARG BUILD_BINARY_NAME={{ binary_name }}

ENV GO_VERSION=1.24 \
    GOPATH=/go \
    PATH=/usr/local/go/bin:/go/bin:$PATH \
    GO111MODULE=on \
    GOPROXY=https://goproxy.cn,direct \
    BUILD_OUTPUT_DIR=${BUILD_OUTPUT_DIR} \
    BUILD_BINARY_NAME=${BUILD_BINARY_NAME}

# download modules if go.mod present
RUN if [ -f go.mod ]; then go mod download; fi

{% if build_script %}
RUN chmod +x {{ build_script }} && /bin/sh {{ build_script }}
{% endif %}

# If entry is a build script (e.g. src/<project>/build.sh), run it.
# Otherwise treat entry_relative_path as a package/directory and run go build on it.
{% if entry_relative_path.endswith('.sh') %}
# ensure output dir exists before running script (script may rely on it)
RUN mkdir -p ${BUILD_OUTPUT_DIR} && /bin/sh {{ entry_relative_path }}
{% else %}
# treat entry_relative_path as package/directory (may be e.g. src/<project> or src/<project>/pkg)
RUN mkdir -p ${BUILD_OUTPUT_DIR} && CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o ${BUILD_OUTPUT_DIR}/${BUILD_BINARY_NAME} {{ entry_relative_path }}
{% endif %}

# Runtime stage - Support custom image
{% if base_image_runtime %}
FROM {{ base_image_runtime }}
{% elif base_image_default_runtime %}
FROM {{ base_image_default_runtime }}
{% else %}
FROM agentkit-cn-beijing.cr.volces.com/base/runtime_basego:latest
{% endif %}

# put binary into a standard location; use the same build-time args to locate artifact
ARG BUILD_OUTPUT_DIR=/app
ARG BUILD_BINARY_NAME={{ binary_name }}
COPY --from=builder ${BUILD_OUTPUT_DIR}/${BUILD_BINARY_NAME} /usr/local/bin/{{ binary_name }}
 
CMD ["/usr/local/bin/{{ binary_name }}"]
